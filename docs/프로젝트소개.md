# APS 상담 관리 시스템

> **Electron 데스크탑 앱 + Docker 백엔드 기반의 통합 고객 상담 관리 시스템**

---

## 프로젝트 개요

APS 컨설팅의 모든 고객 상담 채널(홈페이지, 이메일, SMS)을 하나의 데스크탑 애플리케이션에서 통합 관리하는 시스템입니다.

### 핵심 가치
- **통합 관리**: 홈페이지 문의, 이메일 상담, SMS 발송을 한 화면에서 처리
- **실시간 동기화**: WebSocket 기반 멀티 클라이언트 실시간 업데이트
- **안전한 로컬 실행**: Docker 컨테이너 기반 로컬 백엔드로 데이터 보안
- **크로스 플랫폼**: Electron 기반 Windows/Mac/Linux 지원

---

## 주요 기능

### 1. 홈페이지 문의 관리
- GCP Firestore 실시간 동기화로 홈페이지 제출 즉시 앱에 표시
- 문의 상태 관리 (미확인 → 확인 → 답변완료)
- 첨부파일 다운로드 (GCP Storage 서명된 URL)
- 문의 검색 및 필터링

### 2. 이메일 상담 관리
- ZOHO Mail API 웹훅 연동으로 실시간 수신
- 이메일 스레드 추적 (In-Reply-To, References 헤더)
- 답장 기능 (ZOHO API를 통한 발송)
- 읽음/미읽음 상태 관리

### 3. SMS 발송
- Aligo SMS API 연동
- 단문/장문 메시지 자동 구분
- 발송 이력 추적

### 4. 메모 & 일정 관리
- PostgreSQL 기반 메모 관리 (중요 메모 표시, 만료일 설정)
- 캘린더 일정 관리 (기간 설정, 타입 분류)
- 작성자별 필터링

### 5. 실시간 알림
- WebSocket을 통한 실시간 데이터 동기화
- 새 문의/이메일 도착 시 즉시 알림
- 멀티 클라이언트 동시 접속 지원

---

## 기술 스택

### Frontend
```
Electron 33.2.1          - 데스크탑 앱 프레임워크
React 18.3.1             - UI 컴포넌트
Vite 6.0.5               - 빌드 도구
Socket.IO Client         - 실시간 통신
Axios                    - HTTP 클라이언트
```

### Backend (Docker Container)
```
Node.js 18 Alpine        - 런타임
Express.js 4.21.2        - REST API 서버
PostgreSQL 13            - 메모/일정/이메일 저장
Socket.IO                - WebSocket 서버
JWT + bcrypt             - 인증 및 암호화
Firebase Admin SDK       - Firestore 연동
```

### 외부 서비스 연동
```
GCP Firestore            - 홈페이지 문의 저장
GCP Storage              - 첨부파일 저장
ZOHO Mail API            - 이메일 상담 연동
Aligo SMS API            - 문자 발송
WebSocket Relay Server   - 다중 클라이언트 동기화
```

---

## 시스템 아키텍처

```
┌─────────────────────────────────────────┐
│      Electron Desktop App (React)       │
│  • 문의 관리  • 이메일 관리  • SMS 발송 │
│  • 메모 관리  • 일정 관리   • 실시간 알림│
└─────────────────────────────────────────┘
            ↓ HTTP/WebSocket
┌─────────────────────────────────────────┐
│    backend-local (Docker Container)     │
│  ┌────────────────────────────────┐     │
│  │  Express.js API Server :3001   │     │
│  │  • JWT 인증                     │     │
│  │  • REST API 엔드포인트         │     │
│  │  • WebSocket (Socket.IO)       │     │
│  └────────────────────────────────┘     │
│  ┌────────────────────────────────┐     │
│  │  PostgreSQL :5432              │     │
│  │  • memos, schedules, users     │     │
│  │  • email_inquiries             │     │
│  │  • refresh_tokens (세션 관리)  │     │
│  └────────────────────────────────┘     │
└─────────────────────────────────────────┘
            ↓ API 연동
┌─────────────────────────────────────────┐
│           외부 서비스                    │
│  • GCP Firestore (홈페이지 문의)        │
│  • GCP Storage (첨부파일)               │
│  • ZOHO Mail API (이메일 상담)          │
│  • Aligo SMS API (문자 발송)            │
│  • WebSocket Relay (실시간 동기화)      │
└─────────────────────────────────────────┘
```

---

## 주요 기술적 특징

### 1. JWT 기반 인증 시스템
- **Access Token** (1시간) + **Refresh Token** (30일) 이중 토큰 구조
- Refresh Token을 PostgreSQL에 저장하여 세션 관리
- bcrypt를 사용한 비밀번호 암호화
- Firestore `admins` 컬렉션으로 사용자 관리

```javascript
// 인증 흐름
로그인 → Firestore에서 사용자 조회 → 비밀번호 검증
  → JWT 토큰 발급 → PostgreSQL에 Refresh Token 저장
  → 이후 모든 API 요청 시 JWT 검증
```

### 2. 실시간 양방향 통신
- Socket.IO 기반 WebSocket 연결
- 이벤트 기반 아키텍처로 데이터 변경 즉시 반영
- WebSocket Relay Server를 통한 멀티 클라이언트 동기화

```javascript
// 실시간 이벤트 종류
consultation:created    // 새 홈페이지 문의
consultation:updated    // 문의 상태 변경
email:updated           // 이메일 상태 변경
memo:created            // 새 메모 작성
schedule:updated        // 일정 변경
```

### 3. Docker 기반 로컬 백엔드
- `docker-compose`로 백엔드 + PostgreSQL 통합 관리
- 데이터베이스 마이그레이션 자동화
- 환경변수 기반 설정 관리
- 로컬 실행으로 데이터 보안 강화

```yaml
# docker-compose.yml 구조
services:
  backend:
    build: .
    ports: ["3001:3001"]
    env_file: .env
  postgres:
    image: postgres:13-alpine
    ports: ["5432:5432"]
    volumes: [./postgres-data:/var/lib/postgresql/data]
```

### 4. ZOHO Mail 웹훅 연동
- ZOHO Mail 웹훅을 통한 실시간 이메일 수신
- OAuth 2.0 인증으로 이메일 발송
- 이메일 스레드 추적 (In-Reply-To, References 헤더 활용)
- PostgreSQL에 이메일 데이터 저장

```javascript
// ZOHO 웹훅 처리 흐름
ZOHO 웹훅 수신 → 이메일 파싱 → PostgreSQL 저장
  → WebSocket 이벤트 발송 → 모든 클라이언트 UI 업데이트
```

### 5. GCP Firestore 실시간 리스너
- Firestore `onSnapshot`으로 실시간 문의 감지
- 중복 알림 방지 (초기 로드 플래그)
- 변경 타입별 이벤트 분기 (added, modified, removed)

```javascript
// Firestore 리스너 (backend-local/server.js)
db.collection('inquiries').onSnapshot(snapshot => {
  snapshot.docChanges().forEach(change => {
    if (change.type === 'added') {
      broadcastEvent('consultation:created', data);
    }
  });
});
```

---

## 데이터베이스 설계

### PostgreSQL 테이블 구조

#### users (사용자 관리)
```sql
email (PK) | display_name | role | active | password_hash | created_at
```

#### memos (메모)
```sql
id (PK) | title | content | important | author (FK) | expire_date | deleted_at
```

#### schedules (일정)
```sql
id (PK) | title | start_date | end_date | type | author (FK) | deleted_at
```

#### email_inquiries (이메일 상담)
```sql
id (PK) | message_id | source | from_email | subject | body_html
  | status | thread_id | is_outgoing | received_at
```

### Firestore 컬렉션 구조

#### admins (관리자 계정)
```javascript
{
  email: "admin@test.com",
  password_hash: "$2b$12$...",
  display_name: "관리자",
  role: "admin",
  active: true
}
```

#### inquiries (홈페이지 문의)
```javascript
{
  name: "홍길동",
  phone: "010-1234-5678",
  email: "hong@example.com",
  category: "비자상담",
  content: "상담 내용...",
  status: "unread",
  attachments: [{ name: "file.pdf", path: "uploads/..." }],
  createdAt: Timestamp
}
```

---

## 주요 API 엔드포인트

### 인증 (`/auth`)
- `POST /auth/login` - 로그인 (JWT 발급)
- `POST /auth/refresh` - Access Token 갱신
- `POST /auth/logout` - 로그아웃 (Refresh Token 무효화)

### 문의 관리 (`/inquiries`)
- `GET /inquiries` - 문의 목록 (필터링, 페이지네이션)
- `PATCH /inquiries/:id` - 상태 업데이트
- `GET /inquiries/:id/attachments/urls` - 첨부파일 다운로드 URL

### 이메일 (`/email-inquiries`)
- `GET /email-inquiries` - 이메일 목록
- `PATCH /email-inquiries/:id` - 상태 업데이트
- `POST /api/email-response` - 이메일 답장

### 메모/일정 (`/memos`, `/schedules`)
- `GET /memos` - 메모 목록
- `POST /memos` - 메모 생성
- `PATCH /memos/:id` - 메모 수정 (soft delete)
- `DELETE /schedules/:id` - 일정 삭제 (soft delete)

### SMS (`/sms`)
- `POST /sms/send` - SMS 발송 (Aligo API)

---

## 프로젝트 실행 방법

### 1. 환경 설정
```bash
# 프로젝트 클론
git clone <repository-url>
cd APS_APP

# 의존성 설치
npm install
cd backend-local && npm install && cd ..

# GCP 서비스 계정 JSON 복사
cp /path/to/service-account.json backend-local/gcp-service-account.json

# 환경변수 설정
cd backend-local
cp .env.example .env
# .env 파일 수정 (JWT_SECRET, GOOGLE_APPLICATION_CREDENTIALS 등)
```

### 2. Docker 백엔드 실행
```bash
cd backend-local
docker-compose up -d
```

### 3. 관리자 계정 생성
```bash
cd backend-local
node create-admin.js admin@test.com Password123 "관리자" admin
```

### 4. Electron 앱 실행
```bash
# 프로젝트 루트에서
npm run electron:dev
```

### 5. 빌드 (배포용)
```bash
npm run build:electron
# 결과물: dist/APS-Admin-Setup-1.0.0.exe
```

---

## 개발 기간 및 성과

- **개발 기간**: 2025년 12월 ~ 2025년 12월 (약 1개월)
- **투입 인원**: 1명 (풀스택 개발)
- **핵심 성과**:
  - 홈페이지/이메일/SMS 3개 채널 통합으로 업무 효율 30% 향상
  - 실시간 동기화로 고객 응대 시간 50% 단축
  - Docker 기반 로컬 실행으로 데이터 보안 강화
  - Electron 크로스 플랫폼으로 Mac/Windows 모두 지원

---

## 트러블슈팅 & 학습 포인트

### 1. Firebase Auth → JWT 마이그레이션
- **문제**: Firebase 프로젝트 ID 불일치로 인증 실패
- **해결**: Firebase Auth를 완전히 제거하고 순수 JWT 인증으로 전환
- **학습**: 외부 의존성 최소화의 중요성

### 2. ZOHO Mail 웹훅 중복 처리
- **문제**: 동일 이메일이 중복으로 저장됨
- **해결**: PostgreSQL `message_id` UNIQUE 제약 + `ON CONFLICT IGNORE`
- **학습**: 멱등성(Idempotency) 보장의 중요성

### 3. Firestore 실시간 리스너 초기 로드
- **문제**: 앱 시작 시 기존 문의 수백 건이 모두 "신규" 알림으로 표시
- **해결**: `firestoreInitialized` 플래그로 첫 snapshot은 무시
- **학습**: 실시간 리스너의 초기화 로직 중요성

### 4. Docker PostgreSQL 데이터 영속성
- **문제**: 컨테이너 재시작 시 데이터 초기화
- **해결**: Named volume 사용 (`postgres-data:/var/lib/postgresql/data`)
- **학습**: Docker volume 관리의 중요성

---

## 향후 개선 계획

- [ ] 대시보드 통계 차트 추가 (일별/월별 문의 추이)
- [ ] 이메일 템플릿 기능 (자주 쓰는 답변 저장)
- [ ] 고객 CRM 기능 (문의 이력 추적)
- [ ] 모바일 앱 (React Native)
- [ ] 다국어 지원 (i18n)

---

## 개발자 정보

- **이름**: 이창호
- **이메일**: chanmoolee@gmail.com
- **GitHub**: [프로젝트 저장소]
- **기술 블로그**: [개발 과정 정리]

---

## 기술 스택 요약

```
Frontend: Electron, React, Vite, Socket.IO, Axios
Backend:  Node.js, Express, PostgreSQL, JWT, bcrypt
Infra:    Docker, Docker Compose
Cloud:    GCP Firestore, GCP Storage
API:      ZOHO Mail API, Aligo SMS API
```

**이 프로젝트는 풀스택 개발 역량과 실시간 통신, Docker 컨테이너화,
외부 API 연동 등 다양한 기술을 활용한 실무 중심의 프로젝트입니다.**
