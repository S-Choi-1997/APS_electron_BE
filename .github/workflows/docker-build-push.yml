name: Docker Build and Push

# 트리거 조건
on:
  push:
    branches:
      - main
      - master
      - test/*        # test/ 브랜치 추가 (dev 테스트용)
      - feature/*     # feature/ 브랜치 추가
    tags:
      - 'v*.*.*'  # v1.0.0 형식의 태그
  workflow_dispatch:  # 수동 실행 가능
    inputs:
      version:
        description: 'Docker image version tag'
        required: false
        default: 'latest'

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Extract version from tag
      id: extract_version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          # 태그 푸시: v1.0.0 -> 1.0.0 + latest
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tags=choho97/aps-admin-backend:$VERSION,choho97/aps-admin-backend:latest" >> $GITHUB_OUTPUT
        elif [[ "${{ github.ref }}" == refs/heads/test/* ]] || [[ "${{ github.ref }}" == refs/heads/feature/* ]]; then
          # test/* 또는 feature/* 브랜치: dev 태그로 빌드
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          SAFE_NAME=$(echo "$BRANCH_NAME" | sed 's/\//-/g')
          echo "version=dev-$SAFE_NAME" >> $GITHUB_OUTPUT
          echo "tags=choho97/aps-admin-backend:dev" >> $GITHUB_OUTPUT
        else
          # main/master 브랜치: latest
          echo "version=latest" >> $GITHUB_OUTPUT
          echo "tags=choho97/aps-admin-backend:latest" >> $GITHUB_OUTPUT
        fi

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./backend-local
        push: true
        tags: ${{ steps.extract_version.outputs.tags }}
        cache-from: type=registry,ref=choho97/aps-admin-backend:buildcache
        cache-to: type=registry,ref=choho97/aps-admin-backend:buildcache,mode=max

    - name: Image digest
      run: echo "Image pushed with version ${{ steps.extract_version.outputs.version }}"
