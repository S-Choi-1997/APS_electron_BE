# APS Admin 개발 진행도

**최종 업데이트**: 2025-12-17 (Phase 14 완료)
**프로젝트**: Electron 데스크톱 관리 앱 (React + Node.js + PostgreSQL)

---

## ✅ 완료된 Phase

### Phase 1-6: 기본 UI 구현
- 메모 작성자 자동 설정
- 알림창 메모 작성 기능
- 팀 메모 날짜별 그룹화
- URL 자동 링크 변환 (DOMPurify)
- 일정 날짜 범위 설정
- 메모 상세보기 모달

### Phase 7: API 연동 및 레이아웃 (2025-12-11)
- 백엔드 API 연동 (PostgreSQL + Firestore)
- 메모/일정 CRUD 구현
- 카드 레이아웃 최적화
- 알림창 API 연동 완료

### Phase 8: 실시간 동기화 (2025-12-11)
- Electron IPC 기반 실시간 동기화
- 알림창 ↔ 대시보드 메모 자동 새로고침
- 일정 수정 기능 추가

### Phase 9: CSS 정리 및 UI 개선 (2025-12-12)
- Dashboard.css 대정리 (495줄 → 247줄)
- CSS 모듈화 (Layout, Calendar, Notice, Pending)
- 캘린더 날짜/인디케이터 정렬 수정
- 인디케이터 그라디언트 디자인
- CSS_STRUCTURE.md 문서화

### Phase 10: 사용자 이름 관리 개선 (2025-12-12)
- **localStorage → Backend DB 단일 소스 변경**
- 로그인/세션 복원 시 백엔드에서 display_name 조회
- 백엔드 인증 미들웨어: display_name 덮어쓰기 방지
- 일정 author_name 매핑 추가
- 멀티 디바이스 일관성 확보

### Phase 11: 알림창 UI 개선 및 상담 로직 통일 (2025-12-12)
- **알림창 동적 높이 조절**
  - 내용 변경 시 자동 높이 재계산
  - 초기 로딩: show:false → 계산 → 리사이즈 → show
  - DevTools 제거로 크기 표시 오버레이 제거
- **알림창 UI 개선**
  - 윈도우 크기: 350px → 300px
  - 메모 제목 폰트: 0.75rem → 0.875rem
  - 일정 폰트: 0.75rem → 0.875rem
  - 메모 작성자 우측 정렬
- **메인 윈도우 크기 조정**
  - 가로 1400px → 1500px
- **상담 데이터 로직 통일**
  - 이메일 상담: 0건 (로직 없음)
  - 홈페이지 상담: check=false 기준
  - Dashboard, 알림창 모두 통일된 로직 적용
- **팀 메모 페이지 UI 개선**
  - 제목 크게: 0.9375rem → 1.0625rem, 굵게
  - 내용 작게: 0.8125rem → 0.75rem, 1줄 표시
  - 카드 컴팩트: padding 축소
  - 카드 구분: 배경 #f5f7fa, 카드 white + shadow
- **페이지 스크롤 추가**
  - PageLayout.css에 overflow-y: auto
  - 커스텀 스크롤바 디자인 적용

### Phase 12: 자동 로그인 기능 (2025-12-13)
- **자동 재로그인 구현**
  - 로그인 시 autoLogin 설정 저장 (provider, email)
  - 앱 시작 시 토큰 복원 → 실패 시 자동 재로그인
  - localStorage 기반 (간단한 방식)
- **로직 2단계**
  1. 기존 토큰으로 복원 시도 (만료 안 됨)
  2. 토큰 만료 시 autoLogin 설정으로 OAuth 재실행
- **테스트 대기 중**
  - 토큰 만료까지 대기 후 검증 예정
  - 로그아웃 시 autoLogin 설정 삭제 확인됨

### Phase 13: 메모 UX 개선 및 알림창 투명도 (2025-12-13)
- **메모 만료일 기본값 설정**
  - Dashboard, MemoPage, 알림창 모두 당일 날짜 자동 설정
  - YYYY-MM-DD 형식으로 자동 입력
  - 사용자 편의성 향상 (매번 날짜 입력 불필요)
- **알림창 투명도 조절 슬라이더**
  - 타이틀바에 투명도 조절 슬라이더 추가
  - 범위: 50-100% (드래그로 실시간 조절)
  - Electron IPC 기반 setWindowOpacity API
  - 초기 투명도: 95% (main.js)
- **알림창 메모 필터링 수정**
  - Dashboard.jsx와 동일한 로직 적용
  - ISO 문자열 비교 → Date 객체 비교로 변경
  - setHours(0,0,0,0)로 시간 정규화
  - 만료된 메모 정확하게 필터링

### Phase 14: WebSocket Relay 서버 구축 (2025-12-17)
- **WebSocket Relay 서버 구현 (GCP4)**
  - Node.js + Socket.IO 기반 중계 서버 (포트: 8080)
  - 백엔드와 클라이언트 모두 릴레이에 능동 연결 (아웃바운드)
  - 핸드쉐이크 프로토콜: type(backend/client), version, instanceId
  - 하트비트 모니터링: 30초 간격, 90초 타임아웃
  - 모니터링 대시보드: http://localhost:8080
- **백엔드 Socket.IO 구조 변경**
  - Socket.IO Server → Client로 변경
  - `global.broadcastEvent()` → 릴레이 서버로 이벤트 전송
  - 환경변수: `RELAY_WS_URL`, `BACKEND_VERSION`, `BACKEND_INSTANCE_ID`
  - 도커 컨테이너용: `ws://host.docker.internal:8080`
- **프론트엔드 WebSocket 연결 변경**
  - 백엔드 직접 연결 → 릴레이 서버 연결
  - `websocketService.js`: `VITE_WS_RELAY_URL` 환경변수
  - 개발: `ws://localhost:8080`, 프로덕션: `ws://136.113.67.193:8080`
- **CI/CD 통합**
  - GitHub Actions → Docker Hub 자동 배포
  - `backend_test/` 폴더에서 Docker Compose 배포
  - `.env` 파일 분리: `backend-local/.env` (개발), `backend_test/.env` (프로덕션)
- **실시간 알림 정상 작동 확인 ✅**
  - 메모/일정/상담 생성 → 릴레이 중계 → 알림 표시
  - 백엔드 → 릴레이 → 클라이언트 전체 이벤트 플로우 완성

---

## 📝 남은 작업

### 메모 기능
- [x] ~~메모 수정 기능~~ ✅ 완료 (MemoPage.jsx, Dashboard.jsx)
- [x] ~~메모 만료일~~ ✅ 완료 (expire_date 필드, 대시보드 필터링)
- [ ] 메모 검색 기능
- [ ] 메모 페이지네이션

### UI 개선
- [x] ~~사이드바 상담 메뉴 분리~~ ✅ 완료 (홈페이지/이메일 분리됨)
- [ ] 메뉴 아이콘 추가 (선택사항)

### 고급 기능
- [ ] Firestore 화이트리스트 관리 UI
- [x] ~~자동 로그인~~ ✅ 완료 (localStorage 기반 재로그인)
- [ ] 데이터 동기화 스크립트

---

## 🗂️ 주요 파일 구조

### 생성된 파일
- `src/pages/MemoPage.jsx` - 팀 메모 전용 페이지
- `src/services/memoService.js` - 메모 API
- `src/services/scheduleService.js` - 일정 API
- `src/services/userService.js` - 사용자 API
- `src/config/api.js` - API 공통 설정
- `CSS_STRUCTURE.md` - CSS 문서화

### 핵심 수정 파일
- `src/components/Dashboard.jsx` - 메모/일정 CRUD, IPC 동기화, 메모 만료일 기본값
- `src/pages/MemoPage.jsx` - 팀 메모 페이지, 메모 만료일 기본값
- `src/auth/authManager.js` - 자동 로그인, 백엔드 displayName 조회
- `src/pages/SettingsPage.jsx` - localStorage 제거
- `backend-local/server.js` - Socket.IO Client, WebSocket Relay 연결
- `src/services/websocketService.js` - WebSocket Relay 연결
- `electron/main.js` - IPC 메모 생성, 이벤트 전송, 투명도 핸들러
- `electron/preload.js` - setWindowOpacity IPC 노출
- `public/sticky.html` - 알림창 API 연동, 투명도 슬라이더, 메모 필터링 수정
- `src/components/css/PageLayout.css` - 스크롤바 디자인

### WebSocket Relay 서버 (GCP4)
- `GCP4/ws-relay/server.js` - 중계 서버 메인 로직
- `GCP4/ws-relay/public/index.html` - 모니터링 대시보드
- `GCP4/ws-relay/package.json` - 의존성 (socket.io, express)
- `GCP4/ws-relay/.env` - 서버 설정 (포트, 버전, 타임아웃)

---

## 🔧 기술 스택

- **Frontend**: React 18 + Vite
- **Desktop**: Electron
- **Backend**: Node.js + Express (Docker)
- **Database**: PostgreSQL 15 (메모/일정), GCP Firestore (문의)
- **Auth**: Google OAuth, Naver OAuth
- **Security**: DOMPurify (XSS 방지)

---

## 🐳 Docker 명령어

```powershell
# 시작
cd backend-local
docker-compose up -d

# 재빌드
docker-compose up -d --build

# 중지
docker-compose down

# 로그 확인
docker logs -f aps-admin-backend
```

---

## 📊 현재 상태

### WebSocket Relay 서버 (GCP4)
- ✅ 릴레이 서버 실행 중 (포트: 8080)
- ✅ 백엔드 연결 정상 (backend-local-001)
- ✅ 클라이언트 연결 정상
- ✅ 실시간 이벤트 중계 작동

### 백엔드 서버 (Docker)
- ✅ PostgreSQL 연결 정상 (포트: 5432)
- ✅ API 서버 실행 중 (포트: 3001)
- ✅ Memos/Schedules CRUD 완료
- ✅ 토큰 인증 정상 작동
- ✅ WebSocket Relay 연결 정상

### 프론트엔드 (Electron)
- ✅ API 연동 완료
- ✅ IPC 동기화 완료
- ✅ 사용자 이름 관리 완료
- ✅ CSS 모듈화 완료
- ✅ WebSocket Relay 연결 정상
- ✅ 실시간 알림 작동

---

## 🎯 다음 우선순위

1. 메모 검색 기능
2. 메모 페이지네이션
3. 메뉴 아이콘 추가 (선택사항)
