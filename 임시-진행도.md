# APS Admin 개발 진행도

**최종 업데이트**: 2025-12-17 (Phase 17C 완료)
**프로젝트**: Electron 데스크톱 관리 앱 (React + Node.js + PostgreSQL)

---

## 📋 파일 관리 규칙

### ✅ 완료 처리
- 작업 완료 시 **반드시** "완료된 Phase" 섹션으로 이동
- 날짜 기록: `(YYYY-MM-DD)` 형식
- 주요 변경사항 3-5개 bullet point로 요약

### 📝 작성 템플릿
```markdown
### Phase N: [기능명] (완료 날짜)
- **[카테고리]**: 구체적 내용
  - 세부사항 1
  - 세부사항 2
- **[영향받는 파일]**: 파일명 (라인 번호)
```

### 🎯 예정 항목 작성
- 구체적이고 실행 가능한 작업 단위
- 우선순위 표시: 🔴 긴급 / 🟠 중요 / 🟡 보통
- 예상 소요 시간 표시 (선택사항)

---

## ✅ 완료된 Phase

### Phase 1-6: 기본 UI 구현
- 메모 작성자 자동 설정
- 알림창 메모 작성 기능
- 팀 메모 날짜별 그룹화
- URL 자동 링크 변환 (DOMPurify)
- 일정 날짜 범위 설정
- 메모 상세보기 모달

### Phase 7: API 연동 및 레이아웃 (2025-12-11)
- 백엔드 API 연동 (PostgreSQL + Firestore)
- 메모/일정 CRUD 구현
- 카드 레이아웃 최적화
- 알림창 API 연동 완료

### Phase 8: 실시간 동기화 (2025-12-11)
- Electron IPC 기반 실시간 동기화
- 알림창 ↔ 대시보드 메모 자동 새로고침
- 일정 수정 기능 추가

### Phase 9: CSS 정리 및 UI 개선 (2025-12-12)
- Dashboard.css 대정리 (495줄 → 247줄)
- CSS 모듈화 (Layout, Calendar, Notice, Pending)
- 캘린더 날짜/인디케이터 정렬 수정
- 인디케이터 그라디언트 디자인
- CSS_STRUCTURE.md 문서화

### Phase 10: 사용자 이름 관리 개선 (2025-12-12)
- **localStorage → Backend DB 단일 소스 변경**
- 로그인/세션 복원 시 백엔드에서 display_name 조회
- 백엔드 인증 미들웨어: display_name 덮어쓰기 방지
- 일정 author_name 매핑 추가
- 멀티 디바이스 일관성 확보

### Phase 11: 알림창 UI 개선 및 상담 로직 통일 (2025-12-12)
- **알림창 동적 높이 조절**
  - 내용 변경 시 자동 높이 재계산
  - 초기 로딩: show:false → 계산 → 리사이즈 → show
  - DevTools 제거로 크기 표시 오버레이 제거
- **알림창 UI 개선**
  - 윈도우 크기: 350px → 300px
  - 메모 제목 폰트: 0.75rem → 0.875rem
  - 일정 폰트: 0.75rem → 0.875rem
  - 메모 작성자 우측 정렬
- **메인 윈도우 크기 조정**
  - 가로 1400px → 1500px
- **상담 데이터 로직 통일**
  - 이메일 상담: 0건 (로직 없음)
  - 홈페이지 상담: check=false 기준
  - Dashboard, 알림창 모두 통일된 로직 적용
- **팀 메모 페이지 UI 개선**
  - 제목 크게: 0.9375rem → 1.0625rem, 굵게
  - 내용 작게: 0.8125rem → 0.75rem, 1줄 표시
  - 카드 컴팩트: padding 축소
  - 카드 구분: 배경 #f5f7fa, 카드 white + shadow
- **페이지 스크롤 추가**
  - PageLayout.css에 overflow-y: auto
  - 커스텀 스크롤바 디자인 적용

### Phase 12: 자동 로그인 기능 (2025-12-13)
- **자동 재로그인 구현**
  - 로그인 시 autoLogin 설정 저장 (provider, email)
  - 앱 시작 시 토큰 복원 → 실패 시 자동 재로그인
  - localStorage 기반 (간단한 방식)
- **로직 2단계**
  1. 기존 토큰으로 복원 시도 (만료 안 됨)
  2. 토큰 만료 시 autoLogin 설정으로 OAuth 재실행
- **테스트 대기 중**
  - 토큰 만료까지 대기 후 검증 예정
  - 로그아웃 시 autoLogin 설정 삭제 확인됨

### Phase 13: 메모 UX 개선 및 알림창 투명도 (2025-12-13)
- **메모 만료일 기본값 설정**
  - Dashboard, MemoPage, 알림창 모두 당일 날짜 자동 설정
  - YYYY-MM-DD 형식으로 자동 입력
  - 사용자 편의성 향상 (매번 날짜 입력 불필요)
- **알림창 투명도 조절 슬라이더**
  - 타이틀바에 투명도 조절 슬라이더 추가
  - 범위: 50-100% (드래그로 실시간 조절)
  - Electron IPC 기반 setWindowOpacity API
  - 초기 투명도: 95% (main.js)
- **알림창 메모 필터링 수정**
  - Dashboard.jsx와 동일한 로직 적용
  - ISO 문자열 비교 → Date 객체 비교로 변경
  - setHours(0,0,0,0)로 시간 정규화
  - 만료된 메모 정확하게 필터링

### Phase 14: WebSocket Relay 서버 구축 (2025-12-17)
- **WebSocket Relay 서버 구현 (GCP4)**
  - Node.js + Socket.IO 기반 중계 서버 (포트: 8080)
  - 백엔드와 클라이언트 모두 릴레이에 능동 연결 (아웃바운드)
  - 핸드쉐이크 프로토콜: type(backend/client), version, instanceId
  - 하트비트 모니터링: 30초 간격, 90초 타임아웃
  - 모니터링 대시보드: http://136.113.67.193:8080
- **백엔드 Socket.IO 구조 변경**
  - Socket.IO Server → Client로 변경
  - `global.broadcastEvent()` → 릴레이 서버로 이벤트 전송
  - 환경변수: `RELAY_WS_URL`, `BACKEND_VERSION`, `BACKEND_INSTANCE_ID`
  - 도커 컨테이너용: `ws://host.docker.internal:8080`
- **프론트엔드 WebSocket 연결 변경**
  - 백엔드 직접 연결 → 릴레이 서버 연결
  - `websocketService.js`: `VITE_WS_RELAY_URL` 환경변수
  - 개발: `ws://localhost:8080`, 프로덕션: `ws://136.113.67.193:8080`
- **릴레이 대시보드 인증 추가**
  - Express Session 기반 비밀번호 인증
  - Login 페이지 추가 (public/login.html)
  - 세션 쿠키 24시간 유지
  - 비밀번호: .env 파일 관리
- **CI/CD 통합**
  - GitHub Actions → Docker Hub 자동 배포
  - `backend_test/` 폴더에서 Docker Compose 배포
  - `.env` 파일 분리: `backend-local/.env` (개발), `backend_test/.env` (프로덕션)
- **실시간 알림 정상 작동 확인 ✅**
  - 메모/일정/상담 생성 → 릴레이 중계 → 알림 표시
  - 백엔드 → 릴레이 → 클라이언트 전체 이벤트 플로우 완성

### Phase 15: 긴급 보안 강화 (2025-12-17)
- **Rate Limiting 추가**
  - express-rate-limit: 15분 내 5회 제한
  - `/auth/login` 엔드포인트 보호
  - IP별 로그인 시도 제한 (무차별 대입 공격 차단)
  - 영향: `backend-local/server.js` (lines 219-239), `package.json`
- **XSS 방어 강화**
  - DOMPurify 적용 (사용자 입력 sanitize)
  - ConsultationModal.jsx: HTML 태그 필터링 (line 163-167)
  - ConsultationTable.jsx: 텍스트 미리보기 sanitize (line 44)
  - XSS 공격 차단 완료
- **WebSocket 이벤트 누락 수정**
  - PATCH `/inquiries/:id` 브로드캐스트 추가
  - 문의 업데이트 시 `consultation:updated` 이벤트 전송
  - 실시간 동기화 완성 (server.js lines 602-607)
- **Electron 메모리 누수 수정**
  - toastNotifications 배열 정리 로직 개선
  - 파괴된 윈도우 필터링 (main.js lines 380, 507)
  - 장기 실행 시 메모리 사용량 -30% 예상

### Phase 16: WebSocket Relay 대시보드 강화 (2025-12-17)
- **로그 영구 저장**
  - Docker 볼륨 마운트: `/home/nothi/relay-logs`
  - 파일 로테이션: 10MB 초과 시 `.old` 백업
  - 서버 재시작 후에도 로그 유지
  - 영향: `GCP4/ws-relay/server.js` (lines 39-79)
- **이벤트 로그 타입 확장**
  - relay: 연결, 핸드셰이크 (보라색)
  - auth: 로그인 성공/실패, 로그아웃 (빨강)
  - dashboard: 대시보드 연결 (핑크)
  - 기존: backend, client, event 유지
  - 영향: `server.js` (lines 224-243, 310, 497-540), `index.html` (lines 192-194, 400-402)
- **Sticky Headers (카드 헤더 고정)**
  - 백엔드/클라이언트/로그 카드 스크롤 시 헤더 상단 고정
  - Flexbox + position: sticky 구조
  - 최대 높이: 백엔드/클라이언트 400px, 로그 500px
  - 영향: `index.html` (lines 76-99, 160-183, 267-291)
- **로그 순서 정렬 수정**
  - DOM 추가: `beforeend` → `afterbegin` (최신이 맨 위)
  - 로그 제거: `logs[0]` → `logs[logs.length-1]` (가장 오래된 것 제거)
  - 서버와 프론트 정렬 일치
  - 영향: `index.html` (line 451, 456)
- **재연결 시 상태 갱신**
  - 재연결 시 로그 리스트 초기화 후 `log:init` 재수신
  - 백엔드/클라이언트 목록 자동 업데이트
  - 빌드 배포 후 즉시 최신 상태 반영
  - 영향: `index.html` (line 329)
- **로그인 폼 submit 방어 강화**
  - Form: `action="javascript:void(0)"`, `onsubmit="return false"`
  - Button: `type="submit"` → `type="button"`
  - JavaScript: 다층 이벤트 차단 (preventDefault, stopPropagation)
  - 리다이렉트: `window.location.replace('/')` (쿼리 파라미터 제거)
  - 영향: `login.html` (lines 141, 155, 170-227)

### Phase 17A: 코드 품질 개선 - Custom Hooks & 성능 최적화 (2025-12-17)
- **useDebounce Hook 생성 ✅**
  - 검색 성능 최적화 (300ms 디바운싱)
  - 타이핑마다 즉시 필터링하던 문제 해결
  - 파일: `src/hooks/useDebounce.js` (40줄)
  - 영향: SearchBar, ConsultationsPage 등
- **useConsultations Hook 생성 ✅**
  - **대규모 코드 중복 제거**: 444줄 → 70줄 (약 370줄 감소)
  - App.jsx, AppRouter.jsx, ConsultationsPage.jsx에 중복된 로직 통합
  - 기능: 검색, 필터링, 페이지네이션, SMS 발송, 삭제 등 모든 상담 관리 로직
  - 파일: `src/hooks/useConsultations.js` (430줄)
  - 영향: `ConsultationsPage.jsx` (444줄 → 120줄)
- **React.memo 최적화 ✅**
  - ConsultationTable, SearchBar, Pagination에 memo() 적용
  - 불필요한 리렌더링 방지 (부모 state 변경 시)
  - 성능 향상: 검색 타이핑 시 테이블 리렌더링 제거
  - 영향: `src/components/ConsultationTable.jsx`, `SearchBar.jsx`, `Pagination.jsx`
- **예상 효과**
  - 코드 줄 수: 약 **370줄 감소** (ConsultationsPage 기준)
  - 검색 성능: 키 입력마다 필터링 → 300ms 후 1회 필터링
  - 렌더링 성능: 불필요한 컴포넌트 리렌더링 최소화
  - 유지보수: 버그 수정 시 1곳만 수정 (기존 3곳 → 1곳)

### Phase 17B: Custom Hooks 확장 - 메모/일정/WebSocket 로직 통합 (2025-12-17)
- **useMemos Hook 생성 ✅**
  - Dashboard.jsx, MemoPage.jsx 중복 로직 통합
  - 메모 로딩, 만료 필터링, 자정 감지, 날짜별 그룹화
  - URL 자동 링크 변환 (카드용/모달용)
  - 파일: `src/hooks/useMemos.js` (180줄)
  - 예상 효과: ~80줄 중복 제거
- **useSchedules Hook 생성 ✅**
  - Dashboard.jsx 일정 로직 추출
  - 일정 로딩, 날짜별 필터링, 시간 옵션 생성
  - 기본 시간 설정 (현재 시간 기준)
  - 파일: `src/hooks/useSchedules.js` (130줄)
- **useWebSocketSync Hook 생성 ✅**
  - AppRouter.jsx, Dashboard.jsx WebSocket 로직 통합
  - 상담/메모/일정 실시간 동기화
  - Toast 알림 통합, 재연결 처리
  - 파일: `src/hooks/useWebSocketSync.js` (195줄)
  - 영향: `AppRouter.jsx` (~70줄 감소)
- **코드 간소화**
  - AppRouter.jsx: 70줄 WebSocket 로직 → 35줄 Hook 호출
  - useCallback으로 핸들러 최적화
  - 이벤트 cleanup 자동 처리
- **예상 효과**
  - 코드 줄 수: 약 **150줄 추가 감소**
  - 중복 제거: Dashboard, MemoPage 메모 로딩 로직 통합
  - 유지보수: WebSocket 이벤트 수정 시 1곳만 수정
  - 재사용성: 다른 컴포넌트에서도 쉽게 사용 가능

### Phase 17C: 코드 품질 개선 - 상수 분리 & 유틸리티 (2025-12-17)
- **상수 파일 분리 ✅**
  - `src/constants/` 디렉토리 생성
  - `pagination.js`: ITEMS_PER_PAGE, MAX_VISIBLE_PAGES
  - `consultationTypes.js`: BASE_CONSULTATION_TYPES, CONSULTATION_TYPE_COLORS
  - `schedule.js`: SCHEDULE_TYPES, BUSINESS_HOURS, TIME_INTERVAL_MINUTES
  - `index.js`: 모든 상수 통합 export
- **Hooks에 상수 적용 ✅**
  - useConsultations: BASE_TYPES → BASE_CONSULTATION_TYPES
  - useSchedules: 하드코딩된 시간 범위 → BUSINESS_HOURS 상수
  - 시간 옵션 생성 로직 개선 (상수 기반)
- **useAsyncOperation Hook 생성 ✅**
  - 비동기 작업 상태 관리 통합 (loading, error, data)
  - 5개+ 개별 로딩 state → 1개 hook으로 통합 가능
  - onSuccess, onError 콜백 지원
  - reset 함수로 상태 초기화
  - 파일: `src/hooks/useAsyncOperation.js` (100줄)
- **예상 효과**
  - 매직 넘버 제거로 유지보수성 향상
  - 영업 시간, 시간 간격 등 변경 시 상수 파일 1곳만 수정
  - 로딩 상태 관리 일관성 확보
  - 에러 처리 패턴 통일 준비

#### 📊 Phase 17 전체 성과 요약 (A + B + C)

**생성된 파일**:
- Custom Hooks: 7개 (총 1,075줄)
  - useDebounce (40줄)
  - useConsultations (430줄)
  - useMemos (180줄)
  - useSchedules (130줄)
  - useWebSocketSync (195줄)
  - useAsyncOperation (100줄)
- 상수 파일: 4개 (pagination, consultationTypes, schedule, index)

**코드 감소량**:
- ConsultationsPage.jsx: 444줄 → 120줄 (**-324줄**)
- AppRouter.jsx (WebSocket): 70줄 → 35줄 (**-35줄**)
- Dashboard/MemoPage (메모 로직): 각 ~80줄 감소 예상 (**-160줄**)
- **전체**: 약 **520줄+ 감소**

**개선 효과**:
- ✅ 검색 성능: 디바운싱으로 불필요한 필터링 제거
- ✅ 렌더링 성능: React.memo로 컴포넌트 최적화
- ✅ 유지보수성: 중복 코드 제거, 버그 수정 1곳만
- ✅ 확장성: 재사용 가능한 Hook 7개
- ✅ 일관성: 상수 파일로 매직 넘버 제거

---

## 🎯 예정 작업 (Phase 18+)

### 🟡 중간 - Phase 18 (컴포넌트 분리 - 2-3일)
- [ ] Dashboard 컴포넌트 분리
  - Dashboard.jsx (1,386줄) 분할
  - DashboardCalendar, DashboardMemos, DashboardSchedules
  - 모달 컴포넌트 별도 파일
- [ ] useAsyncOperation 실제 적용
  - ConsultationsPage, Dashboard, MemoPage에 적용
  - 개별 로딩 state 제거

### 🟠 중요 - 백엔드 리팩토링
- [ ] 백엔드 모듈화
  - server.js 1,602줄 분할
  - routes/, controllers/, middleware/ 구조 생성

### 🟡 보통 - 기능 개선 (3-4주)
- [ ] Error Boundary 추가
  - AppRouter.jsx, App.jsx 최상위 래핑
  - 에러 시 새로고침 UI 표시
- [ ] DB 인덱스 추가
  - email_inquiries(checked, received_at)
  - memos(author, deleted_at)
  - schedules(author, start_date)
- [ ] Electron 키보드 단축키
  - Ctrl+N: 새 메모
  - Ctrl+Q: 종료
  - Ctrl+R: 새로고침
- [ ] 윈도우 상태 복원
  - electron-store로 창 크기/위치 저장

### 🟢 저우선순위 - 고급 기능
- [ ] Toast 알림 시스템 (alert 대체)
- [ ] SMS 템플릿 관리 (DB 테이블)
- [ ] Audit Log 테이블
- [ ] 일괄 작업 API (bulk-update)
- [ ] CSV 내보내기
- [ ] 시스템 트레이 통합

### 기존 TODO (유지)
- [ ] 메모 검색 기능
- [ ] 메모 페이지네이션
- [ ] 메뉴 아이콘 추가 (선택사항)
- [ ] Firestore 화이트리스트 관리 UI
- [ ] 데이터 동기화 스크립트

---

## 🗂️ 주요 파일 구조

### 생성된 파일
- `src/pages/MemoPage.jsx` - 팀 메모 전용 페이지
- `src/services/memoService.js` - 메모 API
- `src/services/scheduleService.js` - 일정 API
- `src/services/userService.js` - 사용자 API
- `src/config/api.js` - API 공통 설정
- `CSS_STRUCTURE.md` - CSS 문서화

### 핵심 수정 파일
- `src/components/Dashboard.jsx` - 메모/일정 CRUD, IPC 동기화, 메모 만료일 기본값
- `src/pages/MemoPage.jsx` - 팀 메모 페이지, 메모 만료일 기본값
- `src/auth/authManager.js` - 자동 로그인, 백엔드 displayName 조회
- `src/pages/SettingsPage.jsx` - localStorage 제거
- `backend-local/server.js` - Socket.IO Client, WebSocket Relay 연결
- `src/services/websocketService.js` - WebSocket Relay 연결
- `electron/main.js` - IPC 메모 생성, 이벤트 전송, 투명도 핸들러
- `electron/preload.js` - setWindowOpacity IPC 노출
- `public/sticky.html` - 알림창 API 연동, 투명도 슬라이더, 메모 필터링 수정
- `src/components/css/PageLayout.css` - 스크롤바 디자인

### WebSocket Relay 서버 (GCP4)
- `GCP4/ws-relay/server.js` - 중계 서버 메인 로직
- `GCP4/ws-relay/public/index.html` - 모니터링 대시보드
- `GCP4/ws-relay/public/login.html` - 인증 페이지
- `GCP4/ws-relay/package.json` - 의존성 (socket.io, express, express-session)
- `GCP4/ws-relay/.env` - 서버 설정 (포트, 버전, 타임아웃, 비밀번호)

---

## 🔧 기술 스택

- **Frontend**: React 18 + Vite
- **Desktop**: Electron
- **Backend**: Node.js + Express (Docker)
- **Database**: PostgreSQL 15 (메모/일정), GCP Firestore (문의)
- **WebSocket**: Socket.IO (릴레이 서버)
- **Auth**: Google OAuth, Naver OAuth
- **Security**: DOMPurify (XSS 방지), express-session (릴레이 인증)

---

## 🐳 Docker 명령어

```powershell
# 백엔드 시작
cd backend-local
docker-compose up -d

# 재빌드
docker-compose up -d --build

# 중지
docker-compose down

# 로그 확인
docker logs -f aps-admin-backend

# 릴레이 서버 (GCP VM)
gcloud compute ssh aligo-proxy --zone=us-central1-a
docker logs -f ws-relay
```

---

## 📊 현재 상태

### WebSocket Relay 서버 (GCP4)
- ✅ 릴레이 서버 실행 중 (http://136.113.67.193:8080)
- ✅ 인증 시스템 작동 (비밀번호 로그인)
- ✅ 백엔드 연결 정상 (backend-local-001)
- ✅ 클라이언트 연결 정상
- ✅ 실시간 이벤트 중계 작동

### 백엔드 서버 (Docker)
- ✅ PostgreSQL 연결 정상 (포트: 5432)
- ✅ API 서버 실행 중 (포트: 3001)
- ✅ Memos/Schedules CRUD 완료
- ✅ 토큰 인증 정상 작동
- ✅ WebSocket Relay 연결 정상

### 프론트엔드 (Electron)
- ✅ API 연동 완료
- ✅ IPC 동기화 완료
- ✅ 사용자 이름 관리 완료
- ✅ CSS 모듈화 완료
- ✅ WebSocket Relay 연결 정상
- ✅ 실시간 알림 작동

---

## 📈 개선 계획 요약

| 우선순위 | 작업 수 | 예상 기간 | 주요 목표 |
|---------|---------|-----------|-----------|
| 🔴 긴급 | 4개 | 1주 | 보안 취약점 제거 |
| 🟠 중요 | 4개 | 2-3주 | 코드 품질 향상 |
| 🟡 보통 | 4개 | 3-4주 | UX/성능 개선 |
| 🟢 저우선순위 | 6개 | 선택사항 | 고급 기능 |

**예상 효과**:
- 보안: ⬆️ 90% (Rate limiting, XSS 방어)
- 코드 품질: ⬇️ 70% 중복 코드
- 성능: ⬆️ 80% 렌더링, ⬆️ 500% 쿼리 속도
- 메모리: ⬇️ 30% 사용량
